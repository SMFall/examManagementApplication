<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Tableau de Bord - Professeur</title>
    <!-- JQuery -->
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <!-- Lien vers le fichier CSS personnalisé -->
    <link rel="stylesheet" href="css/style.css">
    <!-- Lien vers Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body>
<div class="dashboard-container d-flex">
    <!-- Sidebar -->
    <aside class="sidebar bg-dark text-white p-4">
        <h2 class="mb-4">Menu</h2>
        <ul class="list-unstyled">
            <li><a href="/missing" class="text-white text-decoration-none">Accueil</a></li>
            <li><a href="/missing" class="text-white text-decoration-none">Mes Cours</a></li>
            <li><a href="/missing" class="text-white text-decoration-none">Étudiants</a></li>
            <li><a href="/missing" class="text-white text-decoration-none">Évaluations</a></li>
            <li><a href="/missing" class="text-white text-decoration-none">Paramètres</a></li>
            <li><a href="/" class="text-white text-decoration-none">Déconnexion</a></li>
        </ul>
    </aside>

    <!-- Content -->
    <main class="content flex-grow-1 p-5">
        <th:block th:if="${#strings.equals(users.role, 'teacher')}">
            <h1 class="mb-4">Espace enseignant</h1>
        </th:block>
        <th:block th:if="${#strings.equals(users.role, 'student')}">
            <h1 class="mb-4">Espace étudiant</h1>
        </th:block>
        <h3>Connecté en tant que
            <span class="text-primary" th:text="${users.firstName}"></span>
            <span class="text-primary" th:text="${users.lastName}"></span>
        </h3>
        Joignable à l'adresse mail <span th:utext="${users.email}" class="text-primary"></span>
        <hr/>
        <section class="stats row g-4">
            <div class="col-sm-6">
                <h2>Liste des quiz</h2>
                <table class="table table-striped table-hover table-responsive">
                    <thead>
                        <tr>
                            <td>Identifiant</td>
                            <td>Nom du quiz</td>
                        </tr>
                    </thead>
                    <tbody>
                    <tr th:each="quiz : ${quizList}">
                        <td th:text="${quiz.id}"></td>
                        <td th:text="${quiz.title}"></td>
                    </tr>
                    </tbody>
                </table>
            </div>
            <div class="col-sm-6">
                <h2>Premier examen d'un enseignant</h2>
                <select id="usersSelect" class="form-select form-select-md">
                    <option selected value="">-- Sélectionnez un enseignant --</option>
                    <option th:each="users : ${usersList}" th:text="${users.firstName + ' ' + users.lastName}" th:value="${users.user_id}"></option>
                </select>
                <table class="table table-striped table-hover table-responsive">
                    <thead>
                    <tr>
                        <td>Identifiant</td>
                        <td>Nom de l'examen</td>
                    </tr>
                    </thead>
                    <tbody id="firstExamByUsers">
                    <!-- le tbody sera rempli par l'api REST depuis l'appel ajax en JS (sur changement de la sélection du nom du prof) -->
                    </tbody>
                </table>
            </div>
        </section>

        <hr/>

        <!-- Statistiques -->
        <section class="stats row g-4">
            <div class="col-md-4">
                <div class="stat-card bg-primary text-white p-4 rounded">
                    <h3>Cours Actifs</h3>
                    <p>5</p>
                </div>
            </div>
            <div class="col-md-4">
                <div class="stat-card bg-info text-white p-4 rounded">
                    <h3>Étudiants Inscrits</h3>
                    <p>120</p>
                </div>
            </div>
            <div class="col-md-4">
                <div class="stat-card bg-warning text-white p-4 rounded">
                    <h3>Devoirs à Corriger</h3>
                    <p>8</p>
                </div>
            </div>
        </section>

        <!-- Graphique -->
        <section class="chart mt-5">
            <h2 class="mb-4">Progression des Étudiants</h2>
            <canvas id="progressChart"></canvas>
        </section>
    </main>
</div>

<!-- Lien vers le script Bootstrap JS -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/js/bootstrap.bundle.min.js"></script>

<script>
    const ctx = document.getElementById('progressChart').getContext('2d');
    new Chart(ctx, {
        type: 'bar',
        data: {
            labels: ['Étudiant A', 'Étudiant B', 'Étudiant C', 'Étudiant D'],
            datasets: [{
                label: 'Moyenne (%)',
                data: [85, 78, 92, 74],
                backgroundColor: 'rgba(54, 162, 235, 0.6)',
                borderColor: 'rgba(54, 162, 235, 1)',
                borderWidth: 1
            }]
        }
    });

    $(document).ready(function () {
        $('#usersSelect').on('change', function () {
            let usersId = $(this).val(); // Récupère l'ID sélectionné
            if (usersId) {
                refreshFirstExamDatatable(usersId);
            } else {
                $('#firstExamByUsers').html('<tr><td colspan="2">Veuillez sélectionner un enseignant</td></tr>');
            }
        });
    });

    function refreshFirstExamDatatable(usersId) {
        $.ajax({
            url: '/api/exams/firstExam/' + usersId,
            type: 'GET',
            dataType: 'json',
            success: function (exam) {
                if (exam && exam.id) { // Vérifie si l'examen existe
                    let tableContent = `
                    <tr>
                        <td>${exam.id}</td>
                        <td>${exam.examTitle}</td>
                    </tr>`;
                    $('#firstExamByUsers').html(tableContent);
                } else {
                    $('#firstExamByUsers').html('<tr><td colspan="2">Aucun examen trouvé</td></tr>');
                }
            },
            error: function () {
                console.error("Erreur lors du chargement des examens.");
                $('#firstExamByUsers').html('<tr><td colspan="2">Aucun examen trouvé</td></tr>');
            }
        });
    }

</script>
</body>
</html>
